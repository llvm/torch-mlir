name: Roll PyTorch

on:
  workflow_dispatch:

jobs:
  build_linux:
    name: Manylinux Build
    runs-on: ubuntu-latest
    steps:
    - name: Get torch-mlir
      uses: actions/checkout@v2
      with:
        submodules: 'true'
    - name: Setup ccache
      uses: ./.github/actions/setup-build
      with:
        cache-suffix: x86_64-out-of-tree-OFF
    - name: Build Python wheels and smoke test.
      run: |
        cd $GITHUB_WORKSPACE
        python -m pip install wheel
        TM_PACKAGE_VERSION=${{ github.event.inputs.python_package_version }}
        printf "TORCH_MLIR_PYTHON_PACKAGE_VERSION=%s\n" $TM_PACKAGE_VERSION > ./torch_mlir_package_version

        # Fetch the most recent nightly PyTorch release
        PT_RELEASE=$(python -m pip index versions -f https://download.pytorch.org/whl/nightly/cpu/torch_nightly.html --pre torch | grep "Available versions" | tr ' ' '\n' | sort -nr | head -n1 | tr -d ',')
        printf "\-f https://download.pytorch.org/whl/nightly/cpu/torch_nightly.html --pre torch==%s\n" "${PT_RELEASE}" > ./pytorch-requirements.txt

        # Fetch the whl file associated with the nightly release
        rm -f torch-"${PT_RELEASE}"-*.whl
        python -m pip download -f https://download.pytorch.org/whl/nightly/cpu/torch_nightly.html --pre "torch==${PT_RELEASE}"

        # Read the commit hash from the downloaded whl file without extracting it
        PT_HASH=$(unzip -p torch-"${PT_RELEASE}"-*.whl torch/version.py | grep git_version | awk '{ print $3 }' | tr -d "'")
        rm torch-"${PT_RELEASE}"-*.whl

        TM_PACKAGES="out-of-tree" TM_USE_PYTORCH_BINARY="OFF" \
        TORCH_MLIR_SRC_PYTORCH_BRANCH="${PT_HASH}" \
        TORCH_MLIR_SRC_PYTORCH_RELEASE="${PT_RELEASE}" \
        ./build_tools/python_deploy/build_linux_packages.sh

    #- name: Pushing changes
    #  uses: ad-m/github-push-action@v0.6.0
    #  with:
    #    github_token: ${{ secrets.WORKFLOW_INVOCATION_TOKEN }}
    #    branch: ${{ github.ref_name }}
    #    tags: true
