name: Roll PyTorch

on:
  workflow_dispatch:

jobs:
  build_linux:
    name: Manylinux Build
    runs-on: ubuntu-latest
    steps:
    - name: Get torch-mlir
      uses: actions/checkout@v2
      with:
        submodules: 'true'
    - name: Setup ccache
      uses: ./.github/actions/setup-build
      with:
        cache-suffix: x86_64-out-of-tree-OFF
    - name: Build Python wheels and smoke test.
      run: |
        cd $GITHUB_WORKSPACE
        python -m pip install wheel
        TM_PACKAGE_VERSION=${{ github.event.inputs.python_package_version }}
        printf "TORCH_MLIR_PYTHON_PACKAGE_VERSION=%s\n" $TM_PACKAGE_VERSION > ./torch_mlir_package_version
        ./build_tools/python_deploy/build_linux_packages.sh
        
    - name: Build and Test
      run: |
        cd $GITHUB_WORKSPACE
        TM_PACKAGES="out-of-tree" TM_USE_PYTORCH_BINARY="OFF" \
        TM_PYTORCH_BRANCH=`git ls-remote https://github.com/pytorch/pytorch refs/heads/master` \
        ./build_tools/python_deploy/build_linux_packages.sh
        
    #- name: Pushing changes
    #  uses: ad-m/github-push-action@v0.6.0
    #  with:
    #    github_token: ${{ secrets.WORKFLOW_INVOCATION_TOKEN }}
    #    branch: ${{ github.ref_name }}
    #    tags: true
